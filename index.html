<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="NodeFlow">
<meta name="theme-color" content="#1e1e21">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>NodeFlow</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  body{background:#1e1e21;font-family:'DM Sans',sans-serif;color:#c4c4c8;height:100vh;height:100dvh;width:100vw;overflow:hidden;display:flex;touch-action:none}

  /* ── Sidebar ── */
  .sidebar{width:260px;min-width:260px;background:#242529;border-right:1px solid #333;display:flex;flex-direction:column;height:100vh;height:100dvh;z-index:60;transition:transform 0.25s ease}
  .sidebar-header{padding:16px;border-bottom:1px solid #333;display:flex;align-items:center;gap:12px}
  .sidebar-logo{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:500;color:#7c6fef;letter-spacing:-0.5px;flex:1}
  .sidebar-close{display:none;background:none;border:none;color:#888;font-size:20px;cursor:pointer;padding:4px 8px}
  .search-box{padding:0 16px 12px;position:relative}
  .search-box input{width:100%;background:#2a2b30;border:1px solid #333;border-radius:8px;padding:8px 12px 8px 32px;color:#c4c4c8;font-family:'DM Sans',sans-serif;font-size:13px;outline:none}
  .search-box input:focus{border-color:#7c6fef}
  .search-box::before{content:'⌕';position:absolute;left:26px;top:50%;transform:translateY(-50%);color:#555;font-size:14px;pointer-events:none}
  .search-results{max-height:200px;overflow-y:auto;border-bottom:1px solid #333;display:none}
  .search-results.show{display:block}
  .search-result{padding:10px 16px;cursor:pointer;font-size:13px;display:flex;flex-direction:column;gap:2px}
  .search-result:hover,.search-result:active{background:#2a2b30}
  .sr-label{color:#c4c4c8;font-weight:500}
  .sr-page{color:#555;font-size:10px}
  .sr-preview{color:#888;font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .pages-header{padding:12px 16px 8px;display:flex;align-items:center;justify-content:space-between}
  .pages-header span{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:#555}
  .pages-header button{background:none;border:none;color:#7c6fef;font-size:20px;cursor:pointer;padding:4px 8px;line-height:1}
  .pages-list{flex:1;overflow-y:auto;padding:4px 8px}
  .page-item{padding:10px 12px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;display:flex;align-items:center;justify-content:space-between;gap:8px}
  .page-item:hover,.page-item:active{background:#2a2b30}
  .page-item.active{background:#7c6fef!important;color:#fff}
  .page-item .page-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .page-item .page-count{font-size:10px;color:#555;background:#1e1e21;padding:2px 6px;border-radius:10px;flex-shrink:0}
  .page-item.active .page-count{background:rgba(255,255,255,0.15);color:#fff}
  .page-item .page-delete{opacity:0;font-size:10px;color:#e55;cursor:pointer;padding:4px 6px}
  .page-item:hover .page-delete{opacity:0.7}
  .page-rename-input{background:transparent;border:none;border-bottom:1px solid #7c6fef;color:#fff;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;outline:none;width:100%;padding:0}
  .sidebar-footer{padding:12px 16px;border-top:1px solid #333;display:flex;gap:4px}
  .sidebar-footer button{flex:1;background:#2a2b30;border:1px solid #333;color:#888;padding:8px;border-radius:6px;font-family:'DM Sans',sans-serif;font-size:11px;cursor:pointer}
  .sidebar-footer button:hover{background:#333;color:#c4c4c8}

  /* ── Main ── */
  .main{flex:1;display:flex;flex-direction:column;position:relative;overflow:hidden}
  .graph-view{flex:1;position:relative;overflow:hidden}
  .graph-view canvas{position:absolute;top:0;left:0;width:100%;height:100%;cursor:grab;touch-action:none}
  .graph-view canvas.grabbing{cursor:grabbing}

  /* Hamburger */
  .hamburger{position:absolute;top:12px;left:12px;z-index:25;background:#242529;border:1px solid #333;border-radius:8px;padding:8px 10px;cursor:pointer;display:none;line-height:1}
  .hamburger span{display:block;width:18px;height:2px;background:#888;margin:3px 0;border-radius:1px;transition:0.2s}

  .graph-status{position:absolute;top:12px;right:12px;z-index:20;text-align:right;pointer-events:none}
  .zoom-text{font-family:'JetBrains Mono',monospace;font-size:11px;color:#555}
  .sync-text{font-family:'JetBrains Mono',monospace;font-size:10px;color:#666;margin-top:2px}

  .graph-toolbar{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);display:flex;gap:4px;background:#242529;border:1px solid #333;border-radius:10px;padding:5px 8px;z-index:20;box-shadow:0 4px 20px rgba(0,0,0,0.4)}
  .graph-toolbar button{background:transparent;border:1px solid transparent;color:#888;padding:6px 10px;border-radius:6px;font-family:'DM Sans',sans-serif;font-size:11px;font-weight:500;cursor:pointer;white-space:nowrap}
  .graph-toolbar button:hover,.graph-toolbar button:active{background:#2a2b30;color:#c4c4c8}
  .graph-toolbar .sep{width:1px;background:#333;margin:0 2px}

  /* ── Note View ── */
  .note-view{position:absolute;top:0;left:0;right:0;bottom:0;background:#1e1e21;z-index:30;display:none;flex-direction:column}
  .note-view.show{display:flex}
  .note-header{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid #333;background:#242529}
  .note-back{background:none;border:1px solid #333;color:#888;padding:6px 14px;border-radius:6px;font-family:'DM Sans',sans-serif;font-size:13px;cursor:pointer;white-space:nowrap}
  .note-back:hover{background:#2a2b30;color:#c4c4c8}
  .note-color-dot{width:14px;height:14px;border-radius:50%;flex-shrink:0}
  .note-title-input{flex:1;background:transparent;border:none;color:#eee;font-family:'DM Sans',sans-serif;font-size:18px;font-weight:700;outline:none;caret-color:#7c6fef;min-width:0}
  .note-body-wrap{flex:1;overflow-y:auto;padding:20px 16px 60px;max-width:720px;width:100%;margin:0 auto}
  .note-body{width:100%;min-height:300px;background:transparent;border:none;color:#c4c4c8;font-family:'DM Sans',sans-serif;font-size:15px;line-height:1.7;outline:none;resize:none;caret-color:#7c6fef}
  .note-meta{padding:8px 16px;border-top:1px solid #333;font-size:10px;color:#555;font-family:'JetBrains Mono',monospace}

  /* ── Edit overlay ── */
  .node-edit-overlay{position:fixed;z-index:40;display:none}
  .node-edit-overlay.show{display:block}
  .node-edit-input{background:#2a2b30;border:1.5px solid #7c6fef;border-radius:8px;padding:8px 12px;color:#eee;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:500;outline:none;min-width:180px;caret-color:#7c6fef;box-shadow:0 4px 20px rgba(124,111,239,0.15)}

  /* ── Context menu ── */
  .context-menu{position:fixed;background:#242529;border:1px solid #3a3b40;border-radius:10px;padding:4px;z-index:200;min-width:160px;box-shadow:0 8px 32px rgba(0,0,0,0.5);display:none}
  .context-menu.show{display:block}
  .context-menu button{display:block;width:100%;text-align:left;background:none;border:none;color:#c4c4c8;font-family:'DM Sans',sans-serif;font-size:13px;padding:10px 12px;border-radius:6px;cursor:pointer}
  .context-menu button:hover,.context-menu button:active{background:#2a2b30}
  .context-menu button.danger{color:#e55}
  .color-dots{display:flex;gap:6px;padding:8px 10px}
  .color-dot{width:20px;height:20px;border-radius:50%;cursor:pointer;border:2px solid transparent}
  .color-dot:hover,.color-dot:active{transform:scale(1.2);border-color:#fff3}

  /* ── Overlay ── */
  .sidebar-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:55;display:none}
  .sidebar-overlay.show{display:block}

  .toast{position:fixed;top:16px;left:50%;transform:translateX(-50%) translateY(-60px);background:#242529;border:1px solid #333;padding:8px 18px;border-radius:10px;font-size:12px;color:#888;z-index:300;transition:transform 0.3s ease;pointer-events:none}
  .toast.show{transform:translateX(-50%) translateY(0)}
  ::-webkit-scrollbar{width:6px}
  ::-webkit-scrollbar-track{background:transparent}
  ::-webkit-scrollbar-thumb{background:#333;border-radius:3px}
  input[type="file"]{display:none}

  /* ═══ MOBILE ═══ */
  @media(max-width:768px){
    .sidebar{position:fixed;top:0;left:0;bottom:0;transform:translateX(-100%);width:280px;min-width:280px;box-shadow:4px 0 20px rgba(0,0,0,0.5)}
    .sidebar.open{transform:translateX(0)}
    .sidebar-close{display:block}
    .hamburger{display:block}
    .graph-toolbar{padding:4px 6px;gap:2px;bottom:12px}
    .graph-toolbar button{padding:6px 8px;font-size:10px}
    .graph-toolbar .sep{margin:0 1px}
    .graph-status{top:12px;right:12px}
    .page-item .page-delete{opacity:0.5}
    .color-dot{width:24px;height:24px}
  }
</style>
</head>
<body>

<!-- Sidebar overlay for mobile -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-logo">NodeFlow</div>
    <button class="sidebar-close" onclick="closeSidebar()">✕</button>
  </div>
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Search nodes & notes..." oninput="handleSearch(this.value)" onfocus="handleSearch(this.value)">
  </div>
  <div class="search-results" id="searchResults"></div>
  <div class="pages-header">
    <span>Pages</span>
    <button onclick="addPage()" title="New page">+</button>
  </div>
  <div class="pages-list" id="pagesList"></div>
  <div class="sidebar-footer">
    <button onclick="exportAll()">↓ Save</button>
    <button onclick="document.getElementById('fileInput').click()">↑ Load</button>
  </div>
</div>

<div class="main">
  <div class="graph-view" id="graphView">
    <canvas id="graphCanvas"></canvas>

    <div class="hamburger" id="hamburgerBtn" onclick="openSidebar()">
      <span></span><span></span><span></span>
    </div>

    <div class="graph-status">
      <div class="zoom-text" id="zoomText">100%</div>
      <div class="sync-text" id="syncStatus">connecting...</div>
    </div>

    <div class="graph-toolbar" id="graphToolbar">
      <button onclick="addNodeAtCenter()">+ Node</button>
      <div class="sep"></div>
      <button onclick="fitView()">⊡ Fit</button>
      <button onclick="togglePhysics()" id="physBtn">⟳ Phys</button>
      <div class="sep"></div>
      <button onclick="clearPage()">✕ Clear</button>
    </div>
  </div>

  <div class="note-view" id="noteView">
    <div class="note-header">
      <button class="note-back" onclick="closeNote()">← Back</button>
      <div class="note-color-dot" id="noteColorDot"></div>
      <input type="text" class="note-title-input" id="noteTitleInput" placeholder="Node title..." oninput="onNoteTitleChange()" spellcheck="false">
    </div>
    <div class="note-body-wrap">
      <textarea class="note-body" id="noteBody" placeholder="Write your notes here...

Tip: Double-click a node or press Enter to open its note." oninput="onNoteBodyChange()" spellcheck="false"></textarea>
    </div>
    <div class="note-meta" id="noteMeta"></div>
  </div>
</div>

<div class="node-edit-overlay" id="editOverlay">
  <input class="node-edit-input" id="editInput" type="text" spellcheck="false">
</div>

<div class="context-menu" id="contextMenu">
  <button onclick="ctxAction('open')">⏎ Open Note</button>
  <button onclick="ctxAction('rename')">✎ Rename</button>
  <button onclick="ctxAction('addChild')">+ Add Child</button>
  <div class="color-dots" id="colorDots"></div>
  <button class="danger" onclick="ctxAction('delete')">✕ Delete</button>
</div>

<div class="toast" id="toast"></div>
<input type="file" id="fileInput" accept=".json" onchange="handleFileLoad(event)">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
// ═══ CONFIG ═══
const SUPABASE_URL = 'https://qsphmbquuruguemgdiym.supabase.co';
const SUPABASE_KEY = 'sb_publishable_-uS8PtHTOvoVc5-MZrkvrA_Wbt5ljBz';
const MAP_ID = 'default';

// ═══ STATE ═══
let pages=[],activePageId=null,nextNodeId=1,nextPageId=1;
let pan={x:0,y:0},zoom=1,physicsEnabled=false;
let selectedNode=null,hoveredNode=null,draggingNode=null;
let panning=false,panStart={x:0,y:0},dragOffset={x:0,y:0};
let contextNodeId=null,editingNode=null,newNodePending=null,openNoteId=null;
let dirty=false,nodeMap={};
let isMobile=window.innerWidth<=768;
let longPressTimer=null,longPressNode=null,touchMoved=false;

const COLORS=['#7c6fef','#ef6f8a','#6fefb2','#efcf6f','#6fb8ef','#ef8f6f','#b86fef','#6fefd4'];
const NR=7,RR=11,LD=160,REP=2500,ATT=0.005,DAMP=0.82,CP=0.0003;

function cp(){return pages.find(p=>p.id===activePageId)}
function cn(){return cp()?.nodes||[]}
function ce(){return cp()?.edges||[]}
function rnm(){nodeMap={};cn().forEach(n=>nodeMap[n.id]=n)}

const canvas=document.getElementById('graphCanvas');
const ctx=canvas.getContext('2d');

function resizeCanvas(){
  const r=canvas.parentElement.getBoundingClientRect();
  canvas.width=r.width;canvas.height=r.height;
  isMobile=window.innerWidth<=768;
}
window.addEventListener('resize',()=>{resizeCanvas();render()});

// ═══ MOBILE SIDEBAR ═══
function openSidebar(){
  document.getElementById('sidebar').classList.add('open');
  document.getElementById('sidebarOverlay').classList.add('show');
}
function closeSidebar(){
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('show');
}

// ═══ NODE CRUD ═══
function createNode(label,wx,wy,parentId,isRoot){
  const page=cp();if(!page)return null;
  const id=nextNodeId++;
  const pc=parentId?((nodeMap[parentId]||{}).color||'#7c6fef'):'#7c6fef';
  const node={id,label,x:wx,y:wy,vx:0,vy:0,isRoot:!!isRoot,color:isRoot?'#7c6fef':pc,pinned:false,notes:''};
  page.nodes.push(node);
  if(parentId!=null)page.edges.push({from:parentId,to:id});
  rnm();dirty=true;renderSidebar();return id;
}

function deleteNode(id){
  const page=cp();if(!page)return;
  const node=nodeMap[id];if(!node||node.isRoot)return;
  const del=new Set(),q=[id];
  while(q.length){const c=q.shift();del.add(c);page.edges.filter(e=>e.from===c).forEach(e=>q.push(e.to))}
  page.nodes=page.nodes.filter(n=>!del.has(n.id));
  page.edges=page.edges.filter(e=>!del.has(e.from)&&!del.has(e.to));
  if(selectedNode===id)selectedNode=null;
  rnm();dirty=true;renderSidebar();physicsBurst(30);
}

function getDepth(nodeId){
  let depth=0,cur=nodeId;
  const edges=ce();
  for(let i=0;i<20;i++){// max 20 to prevent infinite loop
    const parent=edges.find(e=>e.to===cur);
    if(!parent)break;
    depth++;cur=parent.from;
  }
  return depth;
}

function addChild(pid){
  const p=nodeMap[pid];if(!p)return;
  const depth=getDepth(pid);
  // Shrink distance: 100% at depth 0, 65% at depth 1, 45% at depth 2, min 40%
  const scale=Math.max(0.4, 1 - depth*0.35);
  const d=LD*0.7*scale;
  const a=Math.random()*Math.PI*2;
  const id=createNode('',p.x+Math.cos(a)*d,p.y+Math.sin(a)*d,pid);
  selectedNode=id;newNodePending=id;startEdit(id);
  physicsBurst();
  return id;
}

function addNodeAtCenter(){
  const wx=(canvas.width/2-pan.x)/zoom,wy=(canvas.height/2-pan.y)/zoom;
  const id=createNode('',wx+(Math.random()-0.5)*40,wy+(Math.random()-0.5)*40,null,false);
  selectedNode=id;newNodePending=id;startEdit(id);
  physicsBurst();
}

function cancelNewNode(){if(newNodePending){deleteNode(newNodePending);newNodePending=null}}

// ═══ PHYSICS ═══
let burstRemaining=0;

function physicsBurst(frames){
  burstRemaining=Math.max(burstRemaining,frames||50);
  wake();
}

function simulate(){
  const isBurst=burstRemaining>0;
  if(!physicsEnabled&&!isBurst)return;
  if(isBurst)burstRemaining--;

  const nodes=cn(),edges=ce(),n=nodes.length;

  // Repulsion between all pairs
  for(let i=0;i<n;i++)for(let j=i+1;j<n;j++){
    const a=nodes[i],b=nodes[j];
    let dx=b.x-a.x,dy=b.y-a.y,ds=dx*dx+dy*dy;
    if(ds<1)ds=1;const dist=Math.sqrt(ds),f=REP/ds;
    const fx=(dx/dist)*f,fy=(dy/dist)*f;
    if(!a.pinned){a.vx-=fx;a.vy-=fy}if(!b.pinned){b.vx+=fx;b.vy+=fy}
  }

  // Label overlap prevention — extra repulsion when labels would collide
  for(let i=0;i<n;i++)for(let j=i+1;j<n;j++){
    const a=nodes[i],b=nodes[j];
    const dx=b.x-a.x,dy=b.y-a.y;
    const dist=Math.sqrt(dx*dx+dy*dy)||1;
    // Estimate label width: ~7px per character, labels sit below nodes
    const aW=(a.label||'Untitled').length*7+20;
    const bW=(b.label||'Untitled').length*7+20;
    const minDist=(aW+bW)/2+10;
    if(dist<minDist){
      const push=(minDist-dist)*0.05;
      const fx=(dx/dist)*push,fy=(dy/dist)*push;
      if(!a.pinned){a.vx-=fx;a.vy-=fy}if(!b.pinned){b.vx+=fx;b.vy+=fy}
    }
  }

  // Attraction along edges — use depth-aware target distance
  for(let i=0;i<edges.length;i++){
    const e=edges[i],a=nodeMap[e.from],b=nodeMap[e.to];
    if(!a||!b)continue;
    const depth=getDepth(e.to);
    const targetDist=LD*Math.max(0.4, 1-depth*0.25);
    let dx=b.x-a.x,dy=b.y-a.y,dist=Math.sqrt(dx*dx+dy*dy)||1;
    const f=(dist-targetDist)*ATT,fx=(dx/dist)*f,fy=(dy/dist)*f;
    if(!a.pinned){a.vx+=fx;a.vy+=fy}if(!b.pinned){b.vx-=fx;b.vy-=fy}
  }

  let cx=0,cy=0;
  for(let i=0;i<n;i++){cx+=nodes[i].x;cy+=nodes[i].y}
  cx/=n||1;cy/=n||1;
  for(let i=0;i<n;i++){
    const nd=nodes[i];if(nd.pinned)continue;
    nd.vx-=(nd.x-cx)*CP;nd.vy-=(nd.y-cy)*CP;
    nd.vx*=DAMP;nd.vy*=DAMP;nd.x+=nd.vx;nd.y+=nd.vy;
  }
}

// ═══ RENDER ═══
function wts(wx,wy){return{x:wx*zoom+pan.x,y:wy*zoom+pan.y}}
function stw(sx,sy){return{x:(sx-pan.x)/zoom,y:(sy-pan.y)/zoom}}
function nr(n){return(n.isRoot?RR:NR)*Math.max(zoom,0.5)}

function render(){
  const w=canvas.width,h=canvas.height;
  ctx.clearRect(0,0,w,h);
  const nodes=cn(),edges=ce();

  // Edges
  ctx.lineWidth=1.2*zoom;
  edges.forEach(e=>{
    const from=nodeMap[e.from],to=nodeMap[e.to];if(!from||!to)return;
    const p1=wts(from.x,from.y),p2=wts(to.x,to.y);
    const hl=selectedNode&&(e.from===selectedNode||e.to===selectedNode);
    ctx.beginPath();ctx.moveTo(p1.x,p1.y);ctx.lineTo(p2.x,p2.y);
    ctx.strokeStyle=hl?'rgba(124,111,239,0.5)':'rgba(58,59,64,0.5)';
    if(hl)ctx.lineWidth=2*zoom;
    ctx.stroke();ctx.lineWidth=1.2*zoom;
  });

  // Nodes
  nodes.forEach(node=>{
    const p=wts(node.x,node.y),r=nr(node);
    const isSel=selectedNode===node.id,isHov=hoveredNode===node.id;
    const isConn=selectedNode&&edges.some(e=>(e.from===selectedNode&&e.to===node.id)||(e.to===selectedNode&&e.from===node.id));
    const dim=selectedNode&&!isSel&&!isConn;

    // Glow
    if(isSel||isHov){
      ctx.beginPath();ctx.arc(p.x,p.y,r*3,0,Math.PI*2);
      ctx.fillStyle=(node.color||'#7c6fef')+'25';ctx.fill();
    }

    // Circle
    ctx.beginPath();ctx.arc(p.x,p.y,r,0,Math.PI*2);
    ctx.fillStyle=(isSel||isHov)?(node.color||'#7c6fef'):dim?(node.color||'#7c6fef')+'40':(node.color||'#7c6fef')+'bb';
    ctx.fill();
    if(isSel){ctx.strokeStyle='#fff3';ctx.lineWidth=1.5;ctx.stroke()}

    // Note indicator
    if(node.notes&&node.notes.length>0){
      ctx.beginPath();ctx.arc(p.x+r+3,p.y-r-3,3*Math.max(zoom,0.5),0,Math.PI*2);
      ctx.fillStyle='#efcf6f';ctx.fill();
    }

    // Label
    if(editingNode===node.id)return;
    const fs=Math.max((node.isRoot?13:11)*zoom,8);
    ctx.font=`${node.isRoot?600:500} ${fs}px DM Sans`;
    ctx.fillStyle=dim?'#ffffff25':isSel?'#fff':'#ccc';
    ctx.textAlign='center';ctx.textBaseline='top';
    ctx.fillText(node.label||'Untitled',p.x,p.y+r+5*zoom);

    // + button (desktop hover only)
    if(isHov&&!draggingNode&&!isMobile){
      const bx=p.x+r+8*zoom,by=p.y-r-4*zoom,br=7*zoom;
      ctx.beginPath();ctx.arc(bx,by,br,0,Math.PI*2);
      ctx.fillStyle='#2a2b30';ctx.fill();
      ctx.strokeStyle='#555';ctx.lineWidth=1;ctx.stroke();
      ctx.fillStyle='#7c6fef';
      ctx.font=`600 ${11*zoom}px DM Sans`;
      ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText('+',bx,by);
    }
  });
  document.getElementById('zoomText').textContent=Math.round(zoom*100)+'%';
}

// ═══ PAN ANIMATION ═══
let panTarget=null,panAnimating=false;
function panToNode(id){
  const n=nodeMap[id];if(!n)return;
  panTarget={x:canvas.width/2-n.x*zoom,y:canvas.height/2-n.y*zoom,sx:pan.x,sy:pan.y,t0:performance.now(),dur:250};
  panAnimating=true;
}
function updatePan(){
  if(!panAnimating||!panTarget)return;
  const t=Math.min(1,(performance.now()-panTarget.t0)/panTarget.dur);
  const e=1-Math.pow(1-t,3);
  pan.x=panTarget.sx+(panTarget.x-panTarget.sx)*e;
  pan.y=panTarget.sy+(panTarget.y-panTarget.sy)*e;
  if(t>=1){panAnimating=false;panTarget=null}
}

// ═══ LOOP ═══
let sleeping=false,settleCount=0;
function wake(){settleCount=0;if(sleeping){sleeping=false;requestAnimationFrame(loop)}}
function loop(){
  if(sleeping)return;
  simulate();updatePan();render();
  if(!physicsEnabled&&!draggingNode&&!panAnimating&&!panning&&burstRemaining<=0){
    settleCount++;if(settleCount>10){sleeping=true;return}
  }else settleCount=0;
  requestAnimationFrame(loop);
}

// ═══ HIT TEST ═══
function hitTest(sx,sy){
  const w=stw(sx,sy);let cl=null,bd=Infinity;
  const extra=isMobile?20:12;
  cn().forEach(n=>{
    const dx=w.x-n.x,dy=w.y-n.y,d=Math.sqrt(dx*dx+dy*dy);
    const h=(n.isRoot?RR:NR)*2.5/zoom+extra;
    if(d<h&&d<bd){cl=n;bd=d}
  });return cl;
}
function hitAdd(sx,sy){
  if(!hoveredNode||isMobile)return false;
  const n=nodeMap[hoveredNode];if(!n)return false;
  const p=wts(n.x,n.y),r=nr(n);
  const bx=p.x+r+8*zoom,by=p.y-r-4*zoom;
  return Math.sqrt((sx-bx)**2+(sy-by)**2)<10*zoom;
}

// ═══ MOUSE INPUT ═══
canvas.addEventListener('mousedown',e=>{
  if(isMobile)return;
  hideContext();wake();if(e.button===2)return;
  const rect=canvas.getBoundingClientRect();
  const mx=e.clientX-rect.left,my=e.clientY-rect.top;
  if(hitAdd(mx,my)){addChild(hoveredNode);return}
  const node=hitTest(mx,my);
  if(node){
    selectedNode=node.id;draggingNode=node.id;node.pinned=true;
    const p=wts(node.x,node.y);
    dragOffset={x:e.clientX-p.x,y:e.clientY-p.y};
    canvas.classList.add('grabbing');
  }else{
    selectedNode=null;panning=true;
    panStart={x:e.clientX-pan.x,y:e.clientY-pan.y};
    canvas.classList.add('grabbing');
  }
  render();
});

canvas.addEventListener('mousemove',e=>{
  if(isMobile)return;
  const rect=canvas.getBoundingClientRect();
  const mx=e.clientX-rect.left,my=e.clientY-rect.top;
  if(draggingNode){
    wake();const node=nodeMap[draggingNode];if(!node)return;
    const wx=(e.clientX-dragOffset.x-pan.x)/zoom,wy=(e.clientY-dragOffset.y-pan.y)/zoom;
    node.vx=(wx-node.x)*0.3;node.vy=(wy-node.y)*0.3;
    node.x=wx;node.y=wy;dirty=true;
  }else if(panning){
    pan.x=e.clientX-panStart.x;pan.y=e.clientY-panStart.y;
    if(sleeping)render();
  }else{
    const node=hitTest(mx,my);
    const nh=node?node.id:null;
    if(nh!==hoveredNode){hoveredNode=nh;if(sleeping)render()}
    canvas.style.cursor=node?'pointer':'grab';
  }
});

canvas.addEventListener('mouseup',()=>{
  if(isMobile)return;
  if(draggingNode){
    const n=nodeMap[draggingNode];if(n)n.pinned=false;
    draggingNode=null;dirty=true;physicsBurst(30);
  }
  panning=false;canvas.classList.remove('grabbing');
});

canvas.addEventListener('dblclick',e=>{
  if(isMobile)return;
  wake();const rect=canvas.getBoundingClientRect();
  const mx=e.clientX-rect.left,my=e.clientY-rect.top;
  const node=hitTest(mx,my);
  if(node){openNote(node.id)}
  else{const w=stw(mx,my);const id=createNode('',w.x,w.y,null,false);selectedNode=id;newNodePending=id;startEdit(id);physicsBurst()}
});

canvas.addEventListener('contextmenu',e=>{
  e.preventDefault();
  if(isMobile)return;
  const rect=canvas.getBoundingClientRect();
  const node=hitTest(e.clientX-rect.left,e.clientY-rect.top);
  if(node){showContext(node.id,e.clientX,e.clientY)}
});

canvas.addEventListener('wheel',e=>{
  e.preventDefault();wake();
  const old=zoom;
  zoom=Math.max(0.15,Math.min(4,zoom*(e.deltaY>0?0.93:1.07)));
  const rect=canvas.getBoundingClientRect();
  const mx=e.clientX-rect.left,my=e.clientY-rect.top;
  pan.x=mx-(mx-pan.x)*(zoom/old);pan.y=my-(my-pan.y)*(zoom/old);
  render();
},{passive:false});

// ═══ TOUCH INPUT ═══
let lastTouchDist=0,lastTouchMid=null,touchStartTime=0;
let singleTouchNode=null;

canvas.addEventListener('touchstart',e=>{
  e.preventDefault();wake();hideContext();
  const rect=canvas.getBoundingClientRect();

  if(e.touches.length===2){
    // Pinch start
    clearTimeout(longPressTimer);
    const t=e.touches;
    lastTouchDist=Math.hypot(t[0].clientX-t[1].clientX,t[0].clientY-t[1].clientY);
    lastTouchMid={x:(t[0].clientX+t[1].clientX)/2-rect.left,y:(t[0].clientY+t[1].clientY)/2-rect.top};
    return;
  }

  const tx=e.touches[0].clientX-rect.left,ty=e.touches[0].clientY-rect.top;
  touchMoved=false;
  touchStartTime=Date.now();
  const node=hitTest(tx,ty);
  singleTouchNode=node;

  if(node){
    selectedNode=node.id;
    draggingNode=node.id;node.pinned=true;
    const p=wts(node.x,node.y);
    dragOffset={x:e.touches[0].clientX-p.x,y:e.touches[0].clientY-p.y};

    // Long press for context menu
    longPressNode=node.id;
    longPressTimer=setTimeout(()=>{
      if(!touchMoved){
        draggingNode=null;node.pinned=false;
        showContext(node.id,e.touches[0].clientX,e.touches[0].clientY);
      }
    },500);
  }else{
    selectedNode=null;
    panning=true;
    panStart={x:e.touches[0].clientX-pan.x,y:e.touches[0].clientY-pan.y};
  }
  render();
},{passive:false});

canvas.addEventListener('touchmove',e=>{
  e.preventDefault();
  const rect=canvas.getBoundingClientRect();

  if(e.touches.length===2){
    // Pinch zoom
    clearTimeout(longPressTimer);
    const t=e.touches;
    const dist=Math.hypot(t[0].clientX-t[1].clientX,t[0].clientY-t[1].clientY);
    const mid={x:(t[0].clientX+t[1].clientX)/2-rect.left,y:(t[0].clientY+t[1].clientY)/2-rect.top};

    if(lastTouchDist>0){
      const old=zoom;
      zoom=Math.max(0.15,Math.min(4,zoom*(dist/lastTouchDist)));
      pan.x=mid.x-(mid.x-pan.x)*(zoom/old);
      pan.y=mid.y-(mid.y-pan.y)*(zoom/old);
    }
    lastTouchDist=dist;lastTouchMid=mid;
    if(sleeping)render();
    return;
  }

  touchMoved=true;
  clearTimeout(longPressTimer);

  if(draggingNode){
    wake();const node=nodeMap[draggingNode];if(!node)return;
    const wx=(e.touches[0].clientX-dragOffset.x-pan.x)/zoom;
    const wy=(e.touches[0].clientY-dragOffset.y-pan.y)/zoom;
    node.vx=(wx-node.x)*0.3;node.vy=(wy-node.y)*0.3;
    node.x=wx;node.y=wy;dirty=true;
  }else if(panning){
    pan.x=e.touches[0].clientX-panStart.x;
    pan.y=e.touches[0].clientY-panStart.y;
    if(sleeping)render();
  }
},{passive:false});

canvas.addEventListener('touchend',e=>{
  e.preventDefault();
  clearTimeout(longPressTimer);
  lastTouchDist=0;lastTouchMid=null;

  if(draggingNode){
    const n=nodeMap[draggingNode];if(n)n.pinned=false;
    draggingNode=null;dirty=true;physicsBurst(30);
  }
  panning=false;

  // Tap detection: short touch, didn't move much
  if(!touchMoved&&singleTouchNode&&(Date.now()-touchStartTime<300)){
    // Tap on node — select it (already done in touchstart)
    // Double tap detection
    if(singleTouchNode.id===selectedNode&&singleTouchNode._lastTap&&Date.now()-singleTouchNode._lastTap<400){
      openNote(singleTouchNode.id);
      singleTouchNode._lastTap=0;
    }else{
      singleTouchNode._lastTap=Date.now();
    }
  }else if(!touchMoved&&!singleTouchNode&&(Date.now()-touchStartTime<300)){
    selectedNode=null;render();
  }

  singleTouchNode=null;
},{passive:false});

// ═══ KEYBOARD ═══
document.addEventListener('keydown',e=>{
  if(openNoteId){if(e.key==='Escape'){closeNote();e.preventDefault()}return}
  if(editingNode){
    if(e.key==='Escape'){cancelNewNode();stopEdit(false);e.preventDefault()}
    if(e.key==='Enter'){stopEdit(true);e.preventDefault()}
    if(e.key==='Tab'){e.preventDefault();stopEdit(true);if(selectedNode)addChild(selectedNode)}
    return;
  }
  if(e.key==='Escape'){selectedNode=null;hideContext();render()}
  if(e.key==='Enter'&&selectedNode){openNote(selectedNode);e.preventDefault()}
  if(e.key==='F2'&&selectedNode){startEdit(selectedNode);e.preventDefault()}
  if(e.key==='Tab'&&selectedNode){e.preventDefault();addChild(selectedNode)}
  if(e.key==='Delete'&&selectedNode){deleteNode(selectedNode);render()}
  if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.key)){
    e.preventDefault();
    if(!selectedNode){const r=cn().find(n=>n.isRoot)||cn()[0];if(r){selectedNode=r.id;panToNode(r.id);wake()}return}
    const t=findDir(selectedNode,e.key);
    if(t){selectedNode=t.id;panToNode(t.id);wake()}
  }
});

function findDir(fid,dir){
  const from=nodeMap[fid];if(!from)return null;
  const angles={ArrowRight:0,ArrowDown:Math.PI/2,ArrowLeft:Math.PI,ArrowUp:-Math.PI/2};
  const ta=angles[dir];let best=null,bs=Infinity;
  cn().forEach(n=>{
    if(n.id===fid)return;
    const dx=n.x-from.x,dy=n.y-from.y,dist=Math.sqrt(dx*dx+dy*dy);
    if(dist<1)return;
    let ad=Math.atan2(dy,dx)-ta;
    while(ad>Math.PI)ad-=2*Math.PI;while(ad<-Math.PI)ad+=2*Math.PI;
    if(Math.abs(ad)>Math.PI/2)return;
    const s=Math.abs(ad)*300+dist;
    if(s<bs){bs=s;best=n}
  });return best;
}

// ═══ EDIT OVERLAY ═══
function startEdit(id){
  const node=nodeMap[id];if(!node)return;
  editingNode=id;
  const ov=document.getElementById('editOverlay'),inp=document.getElementById('editInput');
  const p=wts(node.x,node.y),r=nr(node);
  const rect=canvas.getBoundingClientRect();

  let left=rect.left+p.x-90,top=rect.top+p.y+r+10;
  // Keep on screen
  if(left<8)left=8;
  if(left+180>window.innerWidth)left=window.innerWidth-188;
  if(top+40>window.innerHeight)top=rect.top+p.y-r-40;

  ov.style.left=left+'px';ov.style.top=top+'px';
  ov.classList.add('show');inp.value=node.label;inp.focus();inp.select();
}

function stopEdit(save){
  if(!editingNode)return;
  const node=nodeMap[editingNode];
  if(node&&save){
    const val=document.getElementById('editInput').value.trim();
    if(val){node.label=val;newNodePending=null}
    else if(newNodePending===editingNode){cancelNewNode()}
    else node.label=node.label||'Untitled';
    dirty=true;renderSidebar();
  }
  editingNode=null;
  document.getElementById('editOverlay').classList.remove('show');
  render();
}

document.getElementById('editInput').addEventListener('blur',()=>{
  if(editingNode){
    const val=document.getElementById('editInput').value.trim();
    if(!val&&newNodePending===editingNode){
      cancelNewNode();editingNode=null;
      document.getElementById('editOverlay').classList.remove('show');render();
    }else stopEdit(true);
  }
});

// ═══ CONTEXT MENU ═══
function showContext(nodeId,cx,cy){
  contextNodeId=nodeId;selectedNode=nodeId;
  const menu=document.getElementById('contextMenu');
  // Position within viewport
  let left=cx,top=cy;
  if(left+160>window.innerWidth)left=window.innerWidth-168;
  if(top+200>window.innerHeight)top=window.innerHeight-208;
  if(left<8)left=8;if(top<8)top=8;
  menu.style.left=left+'px';menu.style.top=top+'px';
  menu.classList.add('show');render();
}

function hideContext(){document.getElementById('contextMenu').classList.remove('show');contextNodeId=null}
function ctxAction(a){
  if(!contextNodeId)return;
  if(a==='open')openNote(contextNodeId);
  if(a==='rename')startEdit(contextNodeId);
  if(a==='addChild')addChild(contextNodeId);
  if(a==='delete'){deleteNode(contextNodeId);render()}
  hideContext();
}
document.addEventListener('click',e=>{if(!document.getElementById('contextMenu').contains(e.target))hideContext()});

(function(){
  const c=document.getElementById('colorDots');
  COLORS.forEach(color=>{
    const d=document.createElement('div');d.className='color-dot';d.style.background=color;
    d.onclick=()=>{if(contextNodeId&&nodeMap[contextNodeId]){nodeMap[contextNodeId].color=color;dirty=true;render()}hideContext()};
    c.appendChild(d);
  });
})();

// ═══ NOTE VIEW ═══
function openNote(id){
  const n=nodeMap[id];if(!n)return;
  openNoteId=id;selectedNode=id;
  document.getElementById('noteTitleInput').value=n.label;
  document.getElementById('noteBody').value=n.notes||'';
  document.getElementById('noteColorDot').style.background=n.color||'#7c6fef';
  updateNoteMeta();
  document.getElementById('noteView').classList.add('show');
  // Focus body after transition
  setTimeout(()=>document.getElementById('noteBody').focus(),100);
}

function closeNote(){
  if(!openNoteId)return;
  openNoteId=null;
  document.getElementById('noteView').classList.remove('show');
  render();
}

function onNoteTitleChange(){
  const n=nodeMap[openNoteId];if(!n)return;
  n.label=document.getElementById('noteTitleInput').value||'Untitled';
  dirty=true;renderSidebar();
}

function onNoteBodyChange(){
  const n=nodeMap[openNoteId];if(!n)return;
  n.notes=document.getElementById('noteBody').value;
  dirty=true;updateNoteMeta();
}

function updateNoteMeta(){
  const n=nodeMap[openNoteId];if(!n)return;
  const words=(n.notes||'').trim().split(/\s+/).filter(w=>w).length;
  const chars=(n.notes||'').length;
  document.getElementById('noteMeta').textContent=words+' words · '+chars+' characters';
}

// ═══ TOOLBAR ═══
function togglePhysics(){
  physicsEnabled=!physicsEnabled;
  document.getElementById('physBtn').textContent='⟳ Phys '+(physicsEnabled?'ON':'OFF');
  wake();
}

function fitView(){
  const nodes=cn();if(!nodes.length)return;
  const pad=isMobile?60:100;
  const xs=nodes.map(n=>n.x),ys=nodes.map(n=>n.y);
  const mnx=Math.min(...xs),mxx=Math.max(...xs),mny=Math.min(...ys),mxy=Math.max(...ys);
  const w=mxx-mnx||400,h=mxy-mny||400;
  zoom=Math.min((canvas.width-pad*2)/w,(canvas.height-pad*2)/h,2);
  pan.x=canvas.width/2-((mnx+mxx)/2)*zoom;
  pan.y=canvas.height/2-((mny+mxy)/2)*zoom;
  render();
}

// ═══ PAGES ═══
function addPage(name){
  const id=nextPageId++;
  pages.push({id,name:name||'New Page',nodes:[],edges:[]});
  switchPage(id);
  const cx=canvas.width/2,cy=canvas.height/2;
  createNode(pages.find(p=>p.id===id).name,(cx-pan.x)/zoom,(cy-pan.y)/zoom,null,true);
  renderSidebar();dirty=true;
  if(isMobile)closeSidebar();
  return id;
}

function switchPage(id){
  if(openNoteId)closeNote();
  stopEdit(false);
  activePageId=id;selectedNode=null;hoveredNode=null;
  pan={x:0,y:0};zoom=1;
  rnm();renderSidebar();resizeCanvas();fitView();physicsBurst();
  if(isMobile)closeSidebar();
}

function deletePage(id){
  if(pages.length<=1)return;
  pages=pages.filter(p=>p.id!==id);
  if(activePageId===id)switchPage(pages[0].id);
  renderSidebar();dirty=true;
}

function renamePage(id,name){
  const p=pages.find(p=>p.id===id);if(!p)return;
  p.name=name;const root=p.nodes.find(n=>n.isRoot);
  if(root)root.label=name;
  dirty=true;renderSidebar();render();
}

function clearPage(){
  const page=cp();if(!page||!confirm('Clear all nodes?'))return;
  page.nodes=[];page.edges=[];
  createNode(page.name,(canvas.width/2-pan.x)/zoom,(canvas.height/2-pan.y)/zoom,null,true);
  selectedNode=null;rnm();dirty=true;renderSidebar();render();
}

// ═══ SIDEBAR ═══
let renamingPageId=null;
function renderSidebar(){
  const list=document.getElementById('pagesList');list.innerHTML='';
  pages.forEach(page=>{
    const item=document.createElement('div');
    item.className='page-item'+(page.id===activePageId?' active':'');
    if(renamingPageId===page.id){
      const inp=document.createElement('input');inp.className='page-rename-input';inp.value=page.name;
      inp.onblur=()=>{renamingPageId=null;renamePage(page.id,inp.value||'Untitled')};
      inp.onkeydown=e=>{if(e.key==='Enter')inp.blur();if(e.key==='Escape'){renamingPageId=null;renderSidebar()}};
      item.appendChild(inp);setTimeout(()=>{inp.focus();inp.select()},10);
    }else{
      const ns=document.createElement('span');ns.className='page-name';ns.textContent=page.name;
      ns.ondblclick=e=>{e.stopPropagation();renamingPageId=page.id;renderSidebar()};
      const ct=document.createElement('span');ct.className='page-count';ct.textContent=page.nodes.length;
      item.appendChild(ns);item.appendChild(ct);
      if(pages.length>1){
        const dl=document.createElement('span');dl.className='page-delete';dl.textContent='✕';
        dl.onclick=e=>{e.stopPropagation();deletePage(page.id)};
        item.appendChild(dl);
      }
      item.onclick=()=>{if(page.id!==activePageId)switchPage(page.id)};
    }
    list.appendChild(item);
  });
}

// ═══ SEARCH ═══
function handleSearch(query){
  const c=document.getElementById('searchResults');
  if(!query.trim()){c.classList.remove('show');c.innerHTML='';return}
  const q=query.toLowerCase(),results=[];
  pages.forEach(page=>page.nodes.forEach(node=>{
    const lm=(node.label||'').toLowerCase().includes(q);
    const nm=(node.notes||'').toLowerCase().includes(q);
    if(lm||nm)results.push({node,page,nm});
  }));
  if(!results.length){c.innerHTML='<div style="padding:12px 16px;font-size:12px;color:#555">No results</div>';c.classList.add('show');return}
  c.innerHTML='';
  results.slice(0,20).forEach(r=>{
    const item=document.createElement('div');item.className='search-result';
    const lb=document.createElement('span');lb.className='sr-label';lb.textContent=r.node.label||'Untitled';
    const pg=document.createElement('span');pg.className='sr-page';pg.textContent=r.page.name;
    item.appendChild(lb);item.appendChild(pg);
    if(r.nm&&r.node.notes){
      const pv=document.createElement('span');pv.className='sr-preview';
      const idx=r.node.notes.toLowerCase().indexOf(q);
      pv.textContent='...'+r.node.notes.substring(Math.max(0,idx-20),idx+40)+'...';
      item.appendChild(pv);
    }
    item.onclick=()=>{
      if(r.page.id!==activePageId)switchPage(r.page.id);
      selectedNode=r.node.id;panToNode(r.node.id);wake();
      c.classList.remove('show');document.getElementById('searchInput').value='';
      if(isMobile)closeSidebar();
    };
    c.appendChild(item);
  });
  c.classList.add('show');
}
document.addEventListener('click',e=>{
  if(!document.querySelector('.search-box').contains(e.target)&&!document.getElementById('searchResults').contains(e.target))
    document.getElementById('searchResults').classList.remove('show');
});

// ═══ SAVE / LOAD ═══
function getAll(){
  return{pages:pages.map(p=>({id:p.id,name:p.name,
    nodes:p.nodes.map(n=>({id:n.id,label:n.label,x:n.x,y:n.y,isRoot:n.isRoot,color:n.color,notes:n.notes||''})),
    edges:p.edges})),activePageId,nextNodeId,nextPageId};
}
function loadAll(d){
  pages=(d.pages||[]).map(p=>({...p,nodes:p.nodes.map(n=>({...n,vx:0,vy:0,pinned:false,notes:n.notes||''}))}));
  nextNodeId=d.nextNodeId||1;nextPageId=d.nextPageId||1;
  activePageId=d.activePageId||(pages[0]?.id);
  selectedNode=null;editingNode=null;openNoteId=null;rnm();renderSidebar();
}
function exportAll(){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([JSON.stringify(getAll(),null,2)],{type:'application/json'}));
  a.download='nodeflow-backup.json';a.click();showToast('Saved');
}
function handleFileLoad(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{try{loadAll(JSON.parse(ev.target.result));fitView();dirty=true;showToast('Loaded')}catch{showToast('Invalid file')}};
  r.readAsText(f);e.target.value='';
}

// ═══ CLOUD ═══
let supa=null,cloudOK=false,saveTO=null;
async function initCloud(){
  try{supa=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);cloudOK=true;syncUI('saved')}catch{syncUI('error')}
}
async function cloudSave(){
  if(!cloudOK)return;
  try{const{error}=await supa.from('maps').upsert({id:MAP_ID,data:getAll(),updated_at:new Date().toISOString()},{onConflict:'id'});if(error)throw error;syncUI('saved')}catch{syncUI('error')}
}
async function cloudLoad(){
  if(!cloudOK)return null;
  try{const{data,error}=await supa.from('maps').select('data').eq('id',MAP_ID).single();if(error&&error.code!=='PGRST116')throw error;return data?.data||null}catch{return null}
}
function localSave(){try{localStorage.setItem('nodeflow-v2',JSON.stringify(getAll()))}catch{}}
function localLoad(){try{const r=localStorage.getItem('nodeflow-v2');return r?JSON.parse(r):null}catch{return null}}
function debSave(){localSave();syncUI('saving');clearTimeout(saveTO);saveTO=setTimeout(()=>cloudSave(),2000)}
function syncUI(s){
  const el=document.getElementById('syncStatus');
  if(s==='saving'){el.textContent='⟳ saving...';el.style.color='#666'}
  if(s==='saved'){el.textContent='☁ synced';el.style.color='#6fefb2'}
  if(s==='error'){el.textContent='⚠ offline';el.style.color='#ef6f8a'}
}
setInterval(()=>{if(dirty){dirty=false;debSave()}},3000);

function showToast(msg){
  const t=document.getElementById('toast');t.textContent=msg;
  t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000);
}

// ═══ SERVICE WORKER ═══
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').catch(()=>{});
}

// ═══ BOOT ═══
async function boot(){
  resizeCanvas();await initCloud();
  const cloud=await cloudLoad();
  if(cloud?.pages?.length){loadAll(cloud);showToast('Loaded from cloud')}
  else{const local=localLoad();if(local?.pages?.length){loadAll(local);dirty=true;showToast('Local → cloud')}else addPage('My Notes')}
  fitView();syncUI('saved');loop();
}
boot();
</script>
</body>
</html>
