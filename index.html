<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="NodeFlow">
<meta name="theme-color" content="#1e1e21">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>NodeFlow</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  body{background:#1e1e21;font-family:'DM Sans',sans-serif;color:#c4c4c8;height:100vh;height:100dvh;width:100vw;overflow:hidden;display:flex;touch-action:none}

  /* ── Sidebar ── */
  .sidebar{width:260px;min-width:260px;background:#242529;border-right:1px solid #333;display:flex;flex-direction:column;height:100vh;height:100dvh;z-index:60;transition:transform 0.25s ease}
  .sidebar-header{padding:16px;border-bottom:1px solid #333;display:flex;align-items:center;gap:12px}
  .sidebar-logo{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:500;color:#7c6fef;letter-spacing:-0.5px;flex:1}
  .sidebar-close{display:none;background:none;border:none;color:#888;font-size:20px;cursor:pointer;padding:4px 8px}
  .search-box{padding:0 16px 12px;position:relative}
  .search-box input{width:100%;background:#2a2b30;border:1px solid #333;border-radius:8px;padding:8px 12px 8px 32px;color:#c4c4c8;font-family:'DM Sans',sans-serif;font-size:13px;outline:none}
  .search-box input:focus{border-color:#7c6fef}
  .search-box::before{content:'⌕';position:absolute;left:26px;top:50%;transform:translateY(-50%);color:#555;font-size:14px;pointer-events:none}
  .search-results{max-height:200px;overflow-y:auto;border-bottom:1px solid #333;display:none}
  .search-results.show{display:block}
  .search-result{padding:10px 16px;cursor:pointer;font-size:13px;display:flex;flex-direction:column;gap:2px}
  .search-result:hover,.search-result:active{background:#2a2b30}
  .sr-label{color:#c4c4c8;font-weight:500}
  .sr-page{color:#555;font-size:10px}
  .sr-preview{color:#888;font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .pages-header{padding:12px 16px 8px;display:flex;align-items:center;justify-content:space-between}
  .pages-header span{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:#555}
  .pages-header button{background:none;border:none;color:#7c6fef;font-size:20px;cursor:pointer;padding:4px 8px;line-height:1}
  .pages-list{flex:1;overflow-y:auto;padding:4px 8px}
  .page-item{padding:10px 12px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;display:flex;align-items:center;justify-content:space-between;gap:8px}
  .page-item:hover,.page-item:active{background:#2a2b30}
  .page-item.active{background:#7c6fef!important;color:#fff}
  .page-item .page-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .page-item .page-count{font-size:10px;color:#555;background:#1e1e21;padding:2px 6px;border-radius:10px;flex-shrink:0}
  .page-item.active .page-count{background:rgba(255,255,255,0.15);color:#fff}
  .page-item .page-delete{opacity:0;font-size:10px;color:#e55;cursor:pointer;padding:4px 6px}
  .page-item:hover .page-delete{opacity:0.7}
  .page-rename-input{background:transparent;border:none;border-bottom:1px solid #7c6fef;color:#fff;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;outline:none;width:100%;padding:0}
  .sidebar-footer{padding:12px 16px;border-top:1px solid #333;display:flex;gap:4px;flex-wrap:wrap}
  .sidebar-footer button{flex:1;background:#2a2b30;border:1px solid #333;color:#888;padding:8px;border-radius:6px;font-family:'DM Sans',sans-serif;font-size:11px;cursor:pointer;min-width:60px}
  .sidebar-footer button:hover{background:#333;color:#c4c4c8}

  /* ── Main ── */
  .main{flex:1;display:flex;flex-direction:column;position:relative;overflow:hidden}
  .graph-view{flex:1;position:relative;overflow:hidden;cursor:grab}
  .graph-view.grabbing{cursor:grabbing}

  /* ── Graph World (pan/zoom container) ── */
  #graphWorld{position:absolute;top:0;left:0;width:0;height:0;transform-origin:0 0}

  /* ── Edge Layer ── */
  #edgeLayer{position:absolute;top:0;left:0;overflow:visible;pointer-events:none}
  #edgeLayer line{stroke:rgba(58,59,64,0.5);stroke-width:1.2}
  #edgeLayer line.hl{stroke:rgba(124,111,239,0.5);stroke-width:2}

  /* ── Node Layer ── */
  #nodeLayer{position:absolute;top:0;left:0}

  /* ── Node Elements ── */
  .nf-node{position:absolute;display:flex;flex-direction:column;align-items:center;cursor:pointer;user-select:none;-webkit-user-select:none;contain:layout style}
  .nf-node.animating{transition:transform 0.3s ease-out}

  .nf-dot{width:14px;height:14px;border-radius:50%;position:relative;flex-shrink:0;margin:3px 0;outline:1px solid transparent}
  .nf-node.root .nf-dot{width:22px;height:22px}
  .nf-node.selected .nf-dot{box-shadow:0 0 0 3px var(--nc),0 0 0 5px rgba(255,255,255,0.15)}
  .nf-node.hovered .nf-dot{box-shadow:0 0 0 2px var(--nc)}
  .nf-node.dim .nf-dot{opacity:0.25}
  .nf-node.dim .nf-label{opacity:0.15}

  /* Status ring via outline */
  .nf-dot.status-todo{outline:2px solid rgba(239,111,138,0.53);outline-offset:2px}
  .nf-dot.status-doing{outline:2px solid rgba(239,207,111,0.53);outline-offset:2px}
  .nf-dot.status-done{outline:2px solid rgba(111,239,178,0.53);outline-offset:2px}

  /* Note indicator */
  .nf-note-ind{position:absolute;top:-2px;right:-4px;width:6px;height:6px;border-radius:50%;background:#efcf6f;pointer-events:none}

  .nf-label{font-size:11px;font-weight:500;color:#ccc;margin-top:5px;white-space:nowrap;text-align:center;pointer-events:none;max-width:150px;overflow:hidden;text-overflow:ellipsis}
  .nf-node.root .nf-label{font-size:14px;font-weight:700}
  .nf-node.selected .nf-label{color:#fff}

  /* Collapse button */
  .nf-collapse-btn{position:absolute;left:-18px;top:50%;transform:translateY(-50%);width:16px;height:16px;border-radius:50%;border:1px solid #555;background:#2a2b30;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;color:#888;cursor:pointer;line-height:1}
  .nf-collapse-btn.collapsed{background:#ef8f6f;border-color:#ef8f6f;color:#fff}

  /* Add child button */
  .nf-add-btn{position:absolute;top:-6px;right:-16px;width:14px;height:14px;border-radius:50%;background:#2a2b30;border:1px solid #555;color:#7c6fef;font-size:11px;font-weight:600;cursor:pointer;display:none;align-items:center;justify-content:center;line-height:1}
  .nf-node.hovered .nf-add-btn{display:flex}

  /* Progress bar */
  .nf-progress{width:40px;height:3px;background:#333;border-radius:2px;margin-top:3px;overflow:hidden;display:none}
  .nf-progress-fill{height:100%;background:#6fefb2;border-radius:2px;transition:width 0.3s}

  .hamburger{position:absolute;top:12px;left:12px;z-index:25;background:#242529;border:1px solid #333;border-radius:8px;padding:8px 10px;cursor:pointer;display:none;line-height:1}
  .hamburger span{display:block;width:18px;height:2px;background:#888;margin:3px 0;border-radius:1px}

  .graph-status{position:absolute;top:12px;right:12px;z-index:20;text-align:right;pointer-events:none}
  .zoom-text{font-family:'JetBrains Mono',monospace;font-size:11px;color:#555}
  .sync-text{font-family:'JetBrains Mono',monospace;font-size:10px;color:#666;margin-top:2px}

  .graph-toolbar{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);display:flex;gap:4px;background:#242529;border:1px solid #333;border-radius:10px;padding:5px 8px;z-index:20;box-shadow:0 4px 20px rgba(0,0,0,0.4);flex-wrap:wrap;justify-content:center}
  .graph-toolbar button{background:transparent;border:1px solid transparent;color:#888;padding:6px 10px;border-radius:6px;font-family:'DM Sans',sans-serif;font-size:11px;font-weight:500;cursor:pointer;white-space:nowrap}
  .graph-toolbar button:hover,.graph-toolbar button:active{background:#2a2b30;color:#c4c4c8}
  .graph-toolbar .sep{width:1px;background:#333;margin:0 2px}

  /* Template dropdown */
  .template-dropdown{position:absolute;bottom:60px;left:50%;transform:translateX(-50%);background:#242529;border:1px solid #333;border-radius:10px;padding:4px;z-index:21;min-width:200px;box-shadow:0 8px 32px rgba(0,0,0,0.5);display:none}
  .template-dropdown.show{display:block}
  .template-dropdown button{display:block;width:100%;text-align:left;background:none;border:none;color:#c4c4c8;font-family:'DM Sans',sans-serif;font-size:12px;padding:10px 12px;border-radius:6px;cursor:pointer}
  .template-dropdown button:hover{background:#2a2b30}
  .template-dropdown .tmpl-desc{color:#555;font-size:10px;margin-top:2px}

  /* ── Note View ── */
  .note-view{position:absolute;top:0;left:0;right:0;bottom:0;background:#1e1e21;z-index:30;display:none;flex-direction:column}
  .note-view.show{display:flex}
  .note-header{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid #333;background:#242529;flex-wrap:wrap}
  .note-back{background:none;border:1px solid #333;color:#888;padding:6px 14px;border-radius:6px;font-family:'DM Sans',sans-serif;font-size:13px;cursor:pointer;white-space:nowrap}
  .note-back:hover{background:#2a2b30;color:#c4c4c8}
  .note-color-dot{width:14px;height:14px;border-radius:50%;flex-shrink:0}
  .note-title-input{flex:1;background:transparent;border:none;color:#eee;font-family:'DM Sans',sans-serif;font-size:18px;font-weight:700;outline:none;caret-color:#7c6fef;min-width:120px}

  /* Status selector in note view */
  .note-status-bar{padding:8px 16px;border-bottom:1px solid #333;background:#242529;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .status-btn{padding:5px 12px;border-radius:14px;font-size:11px;font-weight:600;cursor:pointer;border:1.5px solid transparent;font-family:'DM Sans',sans-serif;transition:all 0.15s}
  .status-btn[data-s="none"]{background:#2a2b30;color:#888;border-color:#333}
  .status-btn[data-s="todo"]{background:#3a2d2d;color:#ef6f8a;border-color:#ef6f8a44}
  .status-btn[data-s="doing"]{background:#3a3520;color:#efcf6f;border-color:#efcf6f44}
  .status-btn[data-s="done"]{background:#1e3a2a;color:#6fefb2;border-color:#6fefb244}
  .status-btn.active{border-color:currentColor !important}
  .note-breadcrumb{padding:6px 16px;font-size:11px;color:#555;display:flex;gap:4px;flex-wrap:wrap;align-items:center}
  .note-breadcrumb span{cursor:pointer;color:#7c6fef}
  .note-breadcrumb span:hover{text-decoration:underline}
  .note-breadcrumb em{color:#333;font-style:normal}

  /* Subtask list in note view */
  .note-subtasks{padding:0 16px 8px;border-bottom:1px solid #333;max-height:40vh;overflow-y:auto}
  .note-subtasks-header{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:#555;padding:8px 0 6px;display:flex;justify-content:space-between;align-items:center}
  .note-subtasks-header button{background:none;border:none;color:#7c6fef;font-size:14px;cursor:pointer;padding:0 4px}
  .subtask-item{display:flex;align-items:center;gap:8px;padding:5px 0;font-size:13px;cursor:pointer;border-radius:4px}
  .subtask-item:hover{background:#2a2b30}
  .subtask-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
  .subtask-label{flex:1;color:#c4c4c8}
  .subtask-status{font-size:9px;font-weight:600;padding:2px 6px;border-radius:8px}

  .note-body-wrap{flex:1;overflow-y:auto;padding:20px 16px 60px;max-width:720px;width:100%;margin:0 auto}
  .note-body{width:100%;min-height:200px;background:transparent;border:none;color:#c4c4c8;font-family:'DM Sans',sans-serif;font-size:15px;line-height:1.7;outline:none;resize:none;caret-color:#7c6fef}
  .note-meta{padding:8px 16px;border-top:1px solid #333;font-size:10px;color:#555;font-family:'JetBrains Mono',monospace}

  /* ── Edit overlay ── */
  .node-edit-overlay{position:fixed;z-index:40;display:none}
  .node-edit-overlay.show{display:block}
  .node-edit-input{background:#2a2b30;border:1.5px solid #7c6fef;border-radius:8px;padding:8px 12px;color:#eee;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:500;outline:none;min-width:180px;caret-color:#7c6fef;box-shadow:0 4px 20px rgba(124,111,239,0.15)}

  /* ── Context menu ── */
  .context-menu{position:fixed;background:#242529;border:1px solid #3a3b40;border-radius:10px;padding:4px;z-index:200;min-width:170px;box-shadow:0 8px 32px rgba(0,0,0,0.5);display:none}
  .context-menu.show{display:block}
  .context-menu button{display:block;width:100%;text-align:left;background:none;border:none;color:#c4c4c8;font-family:'DM Sans',sans-serif;font-size:13px;padding:10px 12px;border-radius:6px;cursor:pointer}
  .context-menu button:hover,.context-menu button:active{background:#2a2b30}
  .context-menu button.danger{color:#e55}
  .ctx-divider{height:1px;background:#333;margin:2px 8px}
  .ctx-status-row{display:flex;gap:4px;padding:6px 10px}
  .ctx-status-dot{width:22px;height:22px;border-radius:50%;cursor:pointer;border:2px solid transparent;display:flex;align-items:center;justify-content:center;font-size:10px}
  .ctx-status-dot:hover{border-color:#fff3;transform:scale(1.15)}
  .color-dots{display:flex;gap:6px;padding:6px 10px}
  .color-dot{width:20px;height:20px;border-radius:50%;cursor:pointer;border:2px solid transparent}
  .color-dot:hover,.color-dot:active{transform:scale(1.2);border-color:#fff3}

  .sidebar-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:55;display:none}
  .sidebar-overlay.show{display:block}

  .toast{position:fixed;top:16px;left:50%;transform:translateX(-50%) translateY(-60px);background:#242529;border:1px solid #333;padding:8px 18px;border-radius:10px;font-size:12px;color:#888;z-index:300;transition:transform 0.3s ease;pointer-events:none}
  .toast.show{transform:translateX(-50%) translateY(0)}
  ::-webkit-scrollbar{width:6px}
  ::-webkit-scrollbar-track{background:transparent}
  ::-webkit-scrollbar-thumb{background:#333;border-radius:3px}
  input[type="file"]{display:none}

  @media(max-width:768px){
    .sidebar{position:fixed;top:0;left:0;bottom:0;transform:translateX(-100%);width:280px;min-width:280px;box-shadow:4px 0 20px rgba(0,0,0,0.5)}
    .sidebar.open{transform:translateX(0)}
    .sidebar-close{display:block}
    .hamburger{display:block}
    .graph-toolbar{padding:4px 6px;gap:2px;bottom:12px}
    .graph-toolbar button{padding:6px 8px;font-size:10px}
    .page-item .page-delete{opacity:0.5}
    .color-dot,.ctx-status-dot{width:24px;height:24px}
    .nf-add-btn{display:none!important}
  }
</style>
</head>
<body>

<div class="sidebar-overlay" id="sidebarOverlay"></div>

<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-logo">NodeFlow</div>
    <button class="sidebar-close" id="sidebarCloseBtn">&#x2715;</button>
  </div>
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Search nodes & notes...">
  </div>
  <div class="search-results" id="searchResults"></div>
  <div class="pages-header">
    <span>Pages</span>
    <button id="addPageBtn" title="New page">+</button>
  </div>
  <div class="pages-list" id="pagesList"></div>
  <div class="sidebar-footer">
    <button id="exportBtn">&#x2193; Save</button>
    <button id="loadBtn">&#x2191; Load</button>
    <button id="mdBtn">&#x1F4CB; MD</button>
  </div>
</div>

<div class="main">
  <div class="graph-view" id="graphView">
    <div id="graphWorld">
      <svg id="edgeLayer" xmlns="http://www.w3.org/2000/svg"></svg>
      <div id="nodeLayer"></div>
    </div>
    <div class="hamburger" id="hamburgerBtn"><span></span><span></span><span></span></div>
    <div class="graph-status">
      <div class="zoom-text" id="zoomText">100%</div>
      <div class="sync-text" id="syncStatus">connecting...</div>
    </div>
    <div class="graph-toolbar" id="graphToolbar">
      <button id="addTaskBtn">+ Task</button>
      <button id="tmplBtn">&#x1F4CB; Template</button>
      <div class="sep"></div>
      <button id="fitBtn">&#x22A1; Fit</button>
      <button id="relayoutBtn">&#x27F3; Re-layout</button>
      <div class="sep"></div>
      <button id="clearBtn">&#x2715; Clear</button>
    </div>
    <div class="template-dropdown" id="templateDropdown"></div>
  </div>

  <div class="note-view" id="noteView">
    <div class="note-header">
      <button class="note-back" id="noteBackBtn">&#x2190; Back</button>
      <div class="note-color-dot" id="noteColorDot"></div>
      <input type="text" class="note-title-input" id="noteTitleInput" placeholder="Task name..." spellcheck="false">
    </div>
    <div class="note-breadcrumb" id="noteBreadcrumb"></div>
    <div class="note-status-bar" id="noteStatusBar">
      <button class="status-btn" data-s="none">&#x2014; None</button>
      <button class="status-btn" data-s="todo">&#x25CB; To Do</button>
      <button class="status-btn" data-s="doing">&#x25D0; Doing</button>
      <button class="status-btn" data-s="done">&#x25CF; Done</button>
    </div>
    <div class="note-subtasks" id="noteSubtasks" style="display:none">
      <div class="note-subtasks-header"><span>Subtasks</span><button id="addSubtaskBtn">+</button></div>
      <div id="subtaskList"></div>
    </div>
    <div class="note-body-wrap">
      <textarea class="note-body" id="noteBody" placeholder="Write notes, details, or instructions here..." spellcheck="false"></textarea>
    </div>
    <div class="note-meta" id="noteMeta"></div>
  </div>
</div>

<div class="node-edit-overlay" id="editOverlay">
  <input class="node-edit-input" id="editInput" type="text" spellcheck="false">
</div>

<div class="context-menu" id="contextMenu">
  <button data-action="open">&#x23CE; Open Task</button>
  <button data-action="rename">&#x270E; Rename</button>
  <button data-action="addChild">+ Add Subtask</button>
  <button data-action="collapse">&#x25C7; Collapse/Expand</button>
  <div class="ctx-divider"></div>
  <div style="padding:4px 12px;font-size:10px;color:#555;font-weight:600">STATUS</div>
  <div class="ctx-status-row" id="ctxStatusRow"></div>
  <div style="padding:4px 12px;font-size:10px;color:#555;font-weight:600">COLOR</div>
  <div class="color-dots" id="colorDots"></div>
  <div class="ctx-divider"></div>
  <button class="danger" data-action="delete">&#x2715; Delete</button>
</div>

<div class="toast" id="toast"></div>
<input type="file" id="fileInput" accept=".json">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="app.js"></script>
</body>
</html>
